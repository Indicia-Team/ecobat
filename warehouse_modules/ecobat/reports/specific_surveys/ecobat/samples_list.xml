<report
    title="List of Ecobat reference range samples"
    description="Lists each unique combination of grid ref, location name and date."
>
  <query>
    SELECT #columns#
    FROM ecobat_occurrences o
    WHERE o.external_key IS NOT NULL
    AND o.autogenerated=FALSE
  </query>
  <order_bys>
    <order_by>grid_ref, o.date_start, o.location_name</order_by>
  </order_bys>
  <params>
    <param name="currentUser" display="User ID" datatype="integer" default="">
      <where>o.created_by_id=#currentUser#</where>
    </param>
  </params>
  <columns>
    <column name="grid_ref" display="Grid reference"  in_count="true"
            sql="case when entered_sref_system='OSGB' then replace(o.entered_sref, ' ', '') else convert_east_north_to_osgb(o.easting, o.northing, 5) end" />
    <column name="date_start" sql="o.date_start" display="Date" />
    <column name="date_start_text" sql="o.date_start::varchar" visible="false" in_count="true" />
    <column name="location_name" display="Location name" sql="o.location_name" in_count="true" />
    <column name="records" display="# Records"
            sql="count(distinct coalesce(o.location_name, '') || o.entered_sref || o.entered_sref_system || o.date_start::text || o.external_key ||
	  o.pass_definition_id::text || o.detector_make_id::text || o.detector_model || coalesce(o.detector_height_m::text, '') ||
	  o.roost_within_25m::text || o.activity_elevated_by_roost::text || coalesce(o.roost_species, '') || coalesce(o.linear_feature_adjacent_id::text, '') ||
	  coalesce(o.linear_feature_25m_id::text, '') || coalesce(o.anthropogenic_feature_adjacent_id::text, '') || coalesce(o.anthropogenic_feature_25m_id::text, '') ||
	  coalesce(o.temperature_c::text, '') || coalesce(o.rainfall_id::text, '') || coalesce(o.wind_speed_mph::text, ''))" aggregate="true" />
  </columns>
</report>