<report
    title="Input params for sample"
    description="Gets the range of parameters for a sample, e.g. the min and max wind speed or temperature to feed into an analysis."
    >
  <query>
    select min(extract(doy from date_start)) as doy_from, max(extract(doy from date_start)) as doy_to,
    avg(st_x(st_centroid(st_transform(geom, 27700)))) as x_avg, avg(st_y(st_centroid(st_transform(geom, 27700)))) as y_avg,
    min(temperature_c) as temperature_c_low, max(temperature_c) as temperature_c_high,
    min(wind_speed_mph) as wind_speed_mph_low, max(wind_speed_mph) as wind_speed_mph_high,
    string_agg(distinct case when autogenerated is true then null else external_key end, ',') as taxa_taxon_list_external_keys,
    string_agg(distinct pass_definition_id::varchar, ',') as pass_definition_ids
    from ecobat_occurrences
    where case
      when entered_sref_system='OSGB' then replace(entered_sref, ' ', '')
      else convert_east_north_to_osgb(easting, northing, 5)
    end = '#input_grid_ref#'
    and date_start='#input_date_start#'
    and coalesce(location_name, '') = '#input_location_name#'
  </query>
  <params>
    <param name="input_grid_ref" display="Sample grid ref" datatype="text" />
    <param name="input_date_start" display="Sample date" datatype="date" />
    <param name="input_location_name" display="Sample location name" datatype="text" />
  </params>
</report>