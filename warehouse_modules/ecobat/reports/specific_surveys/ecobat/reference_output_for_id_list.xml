<report
    title="Reference output basic"
    description="Basic output of a reference range calculation for a range of static bat detector record nights."
>
  <query>
    select fullset.id, fullset.date_start as night, cttl.preferred_taxon as species,
      fullset.passes_summed, round(fullset.percentile*100) as percentile, fullset.autogenerated
    from (
      select id, date_start, taxa_taxon_list_id,
      passes_summed, percent_rank() over (order by passes_summed) as percentile, autogenerated
      from ecobat_occurrences o
      where 1=1
      #filters#
    ) as fullset
    join cache_taxa_taxon_lists cttl on cttl.id=fullset.taxa_taxon_list_id
    where id in (#input_id_list#)
      and 88 in (#website_ids#) -- ensure permissions OK
  </query>
  <order_bys>
    <order_by>o.date_start</order_by>
  </order_bys>
  <params>
    <param name="filter_spatial_km" display="Limit area km" description="Number of km of radius to limit the reference set to." datatype="integer" default="">
      <where>|/ (
        (st_x(st_centroid(st_transform(st_geomfromtext('#input_geom#', 900913), 27700))) - o.easting) ^ 2
        + (st_y(st_centroid(st_transform(st_geomfromtext('#input_geom#', 900913), 27700))) - o.northing) ^ 2
        ) &lt; #filter_spatial_km#*1000</where>
    </param>
    <param name="filter_date" display="Limit day in year" description="Limit to records +/- 30 days of the input" datatype="boolean" default="" >
      <where>
        case
        when extract(doy from '#input_date#'::date) &gt;= 30 and extract(doy from '#input_date#'::date) &lt;= 335 then
        day_of_year &lt;= extract(doy from '#input_date#'::date) + 30 and day_of_year &gt;= extract(doy from '#input_date#'::date) - 30
        when #input_date# &lt; 30 then
        day_of_year &lt;= extract(doy from '#input_date#'::date) + 30 or day_of_year &gt;= extract(doy from '#input_date#'::date) + 365 - 30
        else
        day_of_year &gt;= extract(doy from '#input_date#'::date) - 30 or day_of_year &lt;= extract(doy from '#input_date#'::date) - 365 + 30
        end
      </where>
    </param>
    <param name="filter_temp" display="Limit to similar temperature" description="Limit to records +/- 2deg of the input" datatype="boolean" default="">
      <where>temperature_c between #input_temp#-2 and #input_temp#+2</where>
    </param>
    <param name="filter_wind" display="Limit to similar wind speed" description="Limit to records +/- 2mph of the input" datatype="boolean" default="">
      <where>wind_speed_mph between #input_wind#-2 and #input_wind#+2</where>
    </param>
    <param name="input_id_list" display="" description="List of ecobat occurrence record IDs to compare against the reference range" datatype="integer" />
  </params>
</report>

